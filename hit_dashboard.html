import React, { useState } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
  AreaChart, Area, PieChart, Pie, Cell 
} from 'recharts';
import { 
  Phone, MessageSquare, Headphones, CheckCircle, 
  Users, Filter, Download, Info
} from 'lucide-react';

// --- Mock Data ---

const trendData = [
  { time: '09:00', inbound: 1200, resolved: 980, abandon: 50 },
  { time: '10:00', inbound: 1800, resolved: 1500, abandon: 80 },
  { time: '11:00', inbound: 2400, resolved: 2100, abandon: 120 },
  { time: '12:00', inbound: 1600, resolved: 1300, abandon: 40 },
  { time: '13:00', inbound: 2100, resolved: 1800, abandon: 90 },
  { time: '14:00', inbound: 2600, resolved: 2200, abandon: 150 },
  { time: '15:00', inbound: 2300, resolved: 2000, abandon: 100 },
  { time: '16:00', inbound: 1900, resolved: 1700, abandon: 60 },
  { time: '17:00', inbound: 1400, resolved: 1200, abandon: 30 },
];

const channelData = [
  { name: 'Voice (IVR)', value: 45, color: '#A50034' }, 
  { name: 'Chatbot (AI)', value: 30, color: '#4B5563' },
  { name: 'Live Chat', value: 15, color: '#6B7280' },
  { name: 'App/Web Inquiry', value: 10, color: '#9CA3AF' },
];

const satisfactionData = [
  { name: '매우 만족', value: 65, color: '#10B981' },
  { name: '만족', value: 20, color: '#34D399' },
  { name: '보통', value: 10, color: '#FBBF24' },
  { name: '불만족', value: 5, color: '#EF4444' },
];

// --- Sankey Diagram Constants ---
// 색상 정의 (LG 브랜드 톤 & 직관적 의미)
const COLORS = {
  inbound: '#9CA3AF', // Gray for raw inbound
  voiceBot: '#A50034', // LG Red
  visibleArs: '#D32F2F', 
  touchArs: '#757575',
  direct: '#2E7D32', // Green for VIP/Direct
  selfAttempt: '#E53935', // Reddish for Self-service attempt
  agentConnect: '#2E7D32', // Green for Agent
  selfResolved: '#C62828', // Dark Red
  agentResolved: '#1B5E20', // Dark Green
  drop: '#BDBDBD', // Light Gray
  flowBase: '#FFCDD2', // Light Pink for flows
  flowAgent: '#C8E6C9', // Light Green for agent flows
};

// --- Components ---

const Card = ({ title, children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-5 ${className}`}>
    <h3 className="text-gray-500 text-sm font-semibold mb-3 flex items-center gap-2">
      {title}
    </h3>
    {children}
  </div>
);

const KPICard = ({ title, value, subtext, icon: Icon, trend }) => (
  <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5 flex items-start justify-between">
    <div>
      <p className="text-gray-500 text-sm font-medium mb-1">{title}</p>
      <h4 className="text-2xl font-bold text-gray-800">{value}</h4>
      <p className={`text-xs mt-2 flex items-center ${trend === 'up' ? 'text-green-600' : 'text-red-500'}`}>
        {trend === 'up' ? '▲' : '▼'} {subtext}
      </p>
    </div>
    <div className="p-3 bg-gray-50 rounded-lg text-gray-600">
      <Icon size={20} />
    </div>
  </div>
);

/**
 * Custom Sankey-like Flow Chart using SVG
 * Mimics the logic: Inbound -> ARS Type -> Attempt Type -> Resolution
 */
const CallFlowSankey = () => {
  const [hoveredPath, setHoveredPath] = useState(null);

  // Layout Constants
  const width = 800;
  const height = 400;
  const colX = [50, 250, 500, 750]; // X positions for columns
  const barWidth = 20;

  // Node Data (Y positions and heights calculated based on mocked percentages)
  // Total Height = 350px represents 100%
  
  // Col 1: Total Inbound (One big bar)
  const c1_Total = { x: colX[0], y: 25, h: 350, color: COLORS.inbound, label: "총 콜 인입", value: "1,245,621" };

  // Col 2: ARS Types (VoiceBot, Visible, Touch, Direct)
  const c2_VoiceBot = { x: colX[1], y: 25, h: 105, color: COLORS.voiceBot, label: "보이스봇", value: "30.0%" };
  const c2_Visible = { x: colX[1], y: 140, h: 95, color: COLORS.visibleArs, label: "보이는ARS", value: "27.4%" };
  const c2_Touch = { x: colX[1], y: 245, h: 90, color: COLORS.touchArs, label: "누르는ARS", value: "29.7%" };
  const c2_Direct = { x: colX[1], y: 345, h: 30, color: COLORS.direct, label: "직접연결", value: "12.8%" };

  // Col 3: Attempt Type (Self Service Attempt vs Agent Connect)
  // Grouping by visual proximity to source
  const c3_Self_Top = { x: colX[2], y: 25, h: 80, color: COLORS.selfAttempt, label: "무인시도", value: "46.4%" };
  const c3_Agent_Top = { x: colX[2], y: 115, h: 60, color: COLORS.agentConnect, label: "상담연결", value: "24.9%" };
  
  const c3_Self_Mid = { x: colX[2], y: 185, h: 60, color: COLORS.selfAttempt, label: "무인시도", value: "38.2%" };
  const c3_Agent_Mid = { x: colX[2], y: 255, h: 50, color: COLORS.agentConnect, label: "상담연결", value: "45.1%" };

  const c3_Agent_Bot = { x: colX[2], y: 320, h: 55, color: COLORS.agentConnect, label: "상담연결", value: "87.2%" }; // Direct + Touch flow

  // Col 4: Resolution (Self Resolved, Agent Resolved)
  const c4_SelfRes_Top = { x: colX[3], y: 25, h: 60, color: COLORS.selfResolved, label: "무인해결", value: "46.2%" };
  const c4_AgentRes_Top = { x: colX[3], y: 100, h: 40, color: COLORS.agentResolved, label: "상담해결", value: "85%" };
  
  const c4_SelfRes_Mid = { x: colX[3], y: 160, h: 50, color: COLORS.selfResolved, label: "무인해결", value: "71.4%" };
  const c4_AgentRes_Bot = { x: colX[3], y: 240, h: 100, color: COLORS.agentResolved, label: "상담해결", value: "90%" };

  // Helper to draw bezier curves
  const drawPath = (start, end, color, id) => {
    const controlPoint1X = start.x + (end.x - start.x) / 2;
    const controlPoint2X = end.x - (end.x - start.x) / 2;
    
    // Slight randomization for overlapping flows to look natural
    const startY = start.y + start.h / 2;
    const endY = end.y + end.h / 2;
    const thickness = Math.min(start.h, end.h) * 0.8; // Dynamic thickness based on node height

    const pathData = `
      M ${start.x + barWidth} ${startY - thickness/2}
      C ${controlPoint1X} ${startY - thickness/2}, ${controlPoint2X} ${endY - thickness/2}, ${end.x} ${endY - thickness/2}
      L ${end.x} ${endY + thickness/2}
      C ${controlPoint2X} ${endY + thickness/2}, ${controlPoint1X} ${startY + thickness/2}, ${start.x + barWidth} ${startY + thickness/2}
      Z
    `;

    const isHovered = hoveredPath === id;

    return (
      <path
        key={id}
        d={pathData}
        fill={color}
        opacity={isHovered ? 0.9 : 0.4}
        stroke={isHovered ? color : "none"}
        strokeWidth={1}
        onMouseEnter={() => setHoveredPath(id)}
        onMouseLeave={() => setHoveredPath(null)}
        className="transition-all duration-300 cursor-pointer"
      />
    );
  };

  const renderBar = (node) => (
    <g key={node.label + node.y}>
      <rect x={node.x} y={node.y} width={barWidth} height={node.h} fill={node.color} rx={4} />
      <text x={node.x + barWidth + 5} y={node.y + 15} fontSize="11" fontWeight="bold" fill="#374151">{node.label}</text>
      <text x={node.x + barWidth + 5} y={node.y + 28} fontSize="10" fill="#6B7280">{node.value}</text>
    </g>
  );

  return (
    <div className="w-full overflow-x-auto">
      <div className="min-w-[800px] h-[420px] relative">
        <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`}>
          {/* Headers */}
          <text x={colX[0]} y="15" fontSize="14" fontWeight="bold" fill="#111827" textAnchor="start">ARS 인입</text>
          <text x={colX[1]} y="15" fontSize="14" fontWeight="bold" fill="#111827" textAnchor="start">ARS 메뉴 선택</text>
          <text x={colX[2]} y="15" fontSize="14" fontWeight="bold" fill="#111827" textAnchor="start">상담/무인 시도</text>
          <text x={colX[3]} y="15" fontSize="14" fontWeight="bold" fill="#111827" textAnchor="start">최종 결과</text>

          {/* Links (Flows) */}
          
          {/* Level 1 -> Level 2 */}
          {drawPath(c1_Total, c2_VoiceBot, COLORS.flowBase, 'l1-1')}
          {drawPath(c1_Total, c2_Visible, COLORS.flowBase, 'l1-2')}
          {drawPath(c1_Total, c2_Touch, COLORS.flowBase, 'l1-3')}
          {drawPath(c1_Total, c2_Direct, COLORS.flowAgent, 'l1-4')}

          {/* Level 2 -> Level 3 (VoiceBot) */}
          {drawPath(c2_VoiceBot, c3_Self_Top, COLORS.flowBase, 'l2-1')}
          {drawPath(c2_VoiceBot, c3_Agent_Top, COLORS.flowAgent, 'l2-2')}

          {/* Level 2 -> Level 3 (Visible ARS) */}
          {drawPath(c2_Visible, c3_Self_Mid, COLORS.flowBase, 'l2-3')}
          {drawPath(c2_Visible, c3_Agent_Mid, COLORS.flowAgent, 'l2-4')}

          {/* Level 2 -> Level 3 (Touch & Direct -> Agent) */}
          {drawPath(c2_Touch, c3_Agent_Bot, COLORS.flowAgent, 'l2-5')}
          {drawPath(c2_Direct, c3_Agent_Bot, COLORS.flowAgent, 'l2-6')}

          {/* Level 3 -> Level 4 */}
          {drawPath(c3_Self_Top, c4_SelfRes_Top, COLORS.flowBase, 'l3-1')}
          {drawPath(c3_Self_Top, c4_AgentRes_Top, '#E0E0E0', 'l3-2')} {/* Fallback to agent */}
          
          {drawPath(c3_Self_Mid, c4_SelfRes_Mid, COLORS.flowBase, 'l3-3')}
          
          {drawPath(c3_Agent_Top, c4_AgentRes_Top, COLORS.flowAgent, 'l3-4')}
          {drawPath(c3_Agent_Mid, c4_AgentRes_Bot, COLORS.flowAgent, 'l3-5')}
          {drawPath(c3_Agent_Bot, c4_AgentRes_Bot, COLORS.flowAgent, 'l3-6')}


          {/* Nodes (Bars) */}
          {renderBar(c1_Total)}
          
          {renderBar(c2_VoiceBot)}
          {renderBar(c2_Visible)}
          {renderBar(c2_Touch)}
          {renderBar(c2_Direct)}

          {renderBar(c3_Self_Top)}
          {renderBar(c3_Agent_Top)}
          {renderBar(c3_Self_Mid)}
          {renderBar(c3_Agent_Mid)}
          {renderBar(c3_Agent_Bot)}

          {renderBar(c4_SelfRes_Top)}
          {renderBar(c4_AgentRes_Top)}
          {renderBar(c4_SelfRes_Mid)}
          {renderBar(c4_AgentRes_Bot)}

        </svg>
      </div>
    </div>
  );
};

const DashboardApp = () => {
  const [dateRange, setDateRange] = useState('Today');

  return (
    <div className="min-h-screen bg-gray-50 p-6 font-sans">
      {/* Header */}
      <header className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <span className="w-3 h-8 bg-[#A50034] rounded-sm"></span> {/* LG Red Accent */}
            Customer Journey Analytics
          </h1>
          <p className="text-gray-500 text-sm mt-1 ml-5">LG전자 고객가치혁신 / 하이텔레서비스 통합 관제</p>
        </div>
        
        <div className="flex items-center gap-3">
          <div className="bg-white border border-gray-200 rounded-lg p-1 flex items-center">
             {['Today', 'Week', 'Month'].map((range) => (
               <button 
                key={range}
                onClick={() => setDateRange(range)}
                className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${
                  dateRange === range 
                  ? 'bg-gray-800 text-white shadow-sm' 
                  : 'text-gray-500 hover:bg-gray-100'
                }`}
               >
                 {range}
               </button>
             ))}
          </div>
          <button className="flex items-center gap-2 bg-white border border-gray-200 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
            <Filter size={16} /> 필터
          </button>
          <button className="flex items-center gap-2 bg-[#A50034] text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-[#8a002b]">
            <Download size={16} /> 리포트 다운로드
          </button>
        </div>
      </header>

      {/* Top KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <KPICard 
          title="총 인입 건수 (Total Inflow)" 
          value="1,245,621" 
          subtext="전일 대비 +12%" 
          trend="up"
          icon={Users}
        />
        <KPICard 
          title="무인 처리율 (Self-Service)" 
          value="57.0%" 
          subtext="목표 대비 +2.5%p" 
          trend="up"
          icon={MessageSquare}
        />
        <KPICard 
          title="상담원 연결율 (Connect Rate)" 
          value="43.0%" 
          subtext="전일 대비 -1.2%" 
          trend="down"
          icon={Headphones}
        />
        <KPICard 
          title="문제 해결율 (FCR)" 
          value="88.5%" 
          subtext="안정적 유지 중" 
          trend="up"
          icon={CheckCircle}
        />
      </div>

      {/* Main Analysis Section */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        {/* Journey Flow (Span 3 cols for full width impact) */}
        <Card title="ARS Call Flow Analysis (상담 여정 상세 흐름)" className="lg:col-span-3">
          <div className="py-2">
             <CallFlowSankey />
          </div>
          <div className="mt-4 pt-4 border-t border-gray-100 flex gap-6 text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">
             <div className="flex items-center gap-2">
                <div className="w-3 h-3 bg-[#A50034] rounded-full"></div>
                <span><strong>보이스봇/ARS:</strong> 무인 처리 중심 경로</span>
             </div>
             <div className="flex items-center gap-2">
                <div className="w-3 h-3 bg-[#2E7D32] rounded-full"></div>
                <span><strong>상담원 연결:</strong> 전문 상담사 개입 경로</span>
             </div>
             <div className="flex items-center gap-2 ml-auto">
                <Info size={16} className="text-gray-400"/>
                <span>막대 높이는 인입량을 의미하며, 흐름선(Flow) 굵기는 이동 비율을 나타냅니다.</span>
             </div>
          </div>
        </Card>
      </div>

      {/* Secondary Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* Channel Mix */}
        <Card title="채널별 인입 비중">
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={channelData}
                  cx="50%"
                  cy="50%"
                  innerRadius={60}
                  outerRadius={80}
                  paddingAngle={5}
                  dataKey="value"
                >
                  {channelData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
                <Legend verticalAlign="bottom" height={36}/>
              </PieChart>
            </ResponsiveContainer>
          </div>
        </Card>

        <Card title="시간대별 인입 추이">
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={trendData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                <defs>
                  <linearGradient id="colorInbound" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#A50034" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#A50034" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                <XAxis dataKey="time" />
                <YAxis />
                <Tooltip />
                <Area type="monotone" dataKey="inbound" stroke="#A50034" fillOpacity={1} fill="url(#colorInbound)" />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </Card>

        <Card title="고객 만족도 (CSAT)">
           <div className="h-64 flex flex-col justify-center items-center">
             <h4 className="text-5xl font-bold text-gray-800 mb-2">4.2</h4>
             <div className="flex gap-1 mb-4">
                {[1,2,3,4].map(i => <span key={i} className="text-yellow-400 text-2xl">★</span>)}
                <span className="text-gray-300 text-2xl">★</span>
             </div>
             <div className="w-full px-4">
                {satisfactionData.map((item) => (
                  <div key={item.name} className="flex items-center gap-2 mb-2">
                    <span className="text-xs w-16 text-gray-500">{item.name}</span>
                    <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div className="h-full rounded-full" style={{width: `${item.value}%`, backgroundColor: item.color}}></div>
                    </div>
                    <span className="text-xs w-8 text-right font-medium">{item.value}%</span>
                  </div>
                ))}
             </div>
           </div>
        </Card>
      </div>

    </div>
  );
};

export default DashboardApp;
