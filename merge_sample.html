<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 병합 시각화</title>
    <!-- Tailwind CSS (스타일링) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (아이콘) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 추가적인 커스텀 스타일이 필요하다면 여기에 작성 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* 스크롤바 커스터마이징 (선택 사항) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="min-h-screen p-6 overflow-y-auto">
        <div class="max-w-5xl mx-auto">
            
            <!-- 헤더 -->
            <header class="mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 mb-2 flex items-center gap-3">
                        <i data-lucide="combine" class="text-blue-600"></i>
                        데이터 병합 옵션 시각화
                    </h1>
                    <p class="text-slate-600">
                        데이터베이스나 데이터 처리 도구(Pandas 등)에서 데이터를 합치는 방식(Merge/Join)을 시각적으로 학습합니다.
                    </p>
                </div>
                <button id="btn-fullscreen" class="flex items-center gap-2 px-4 py-2 bg-white text-slate-600 border border-slate-200 rounded-lg shadow-sm hover:text-blue-600 hover:bg-blue-50 transition-all font-medium">
                    <i data-lucide="maximize" width="18"></i>
                    <span id="text-fullscreen">전체화면</span>
                </button>
            </header>

            <!-- 메인 그리드 -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- 왼쪽 컨트롤 패널 -->
                <div class="lg:col-span-5 space-y-6">
                    
                    <!-- 1. 병합 방식 선택 -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="layers" class="text-slate-500" width="20"></i> 1. 병합 방식 선택
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Join Group -->
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="mainMode" value="join" checked class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <span class="font-semibold text-slate-900">Normal Merge (Joins)</span>
                                </label>
                                
                                <div id="join-options" class="ml-8 space-y-2 p-3 bg-slate-50 rounded-lg border border-slate-100 transition-all">
                                    <select id="select-join-sub" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none">
                                        <option value="inner">Inner Join (교집합)</option>
                                        <option value="left">Left Outer Join (왼쪽 기준)</option>
                                    </select>
                                    <p id="join-desc" class="text-xs text-slate-500 mt-1">
                                        양쪽 테이블에 공통된 "키(Key)"가 있는 데이터만 남깁니다.
                                    </p>
                                </div>
                            </div>

                            <!-- Union Group -->
                            <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <input type="radio" name="mainMode" value="union" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    <span class="font-semibold text-slate-900">Union (결합)</span>
                                </div>

                                <div id="union-options" class="ml-8 flex flex-col gap-2 p-3 bg-slate-50 rounded-lg border border-slate-100 hidden">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="unionSub" value="union" checked class="text-blue-600">
                                        <span class="text-sm">Union (중복 제거)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="unionSub" value="unionAll" class="text-blue-600">
                                        <span class="text-sm">Union All (모두 포함)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 입력 데이터 -->
                    <div class="space-y-2">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="database" class="text-slate-500" width="20"></i> 2. 입력 데이터 (Input)
                        </h2>
                        <div id="input-tables-container" class="grid grid-cols-2 gap-2 h-48">
                            <!-- 자바스크립트로 테이블 렌더링 -->
                        </div>
                        <p id="input-hint" class="text-xs text-slate-500 text-right">
                            * 직원의 부서ID와 부서의 ID가 연결 고리(Key)입니다.
                        </p>
                    </div>

                </div>

                <!-- 오른쪽 결과 패널 -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2">
                            <i data-lucide="combine" class="text-blue-600" width="20"></i> 3. 병합 결과 시각화
                        </h2>

                        <!-- 시각화 영역 -->
                        <div class="bg-slate-50 rounded-lg p-4 mb-4 flex flex-col items-center justify-center border border-slate-100 min-h-[200px]">
                            <div id="visualization-area" class="w-full flex justify-center">
                                <!-- SVG나 HTML 다이어그램이 들어갈 곳 -->
                            </div>
                            <div class="mt-4 text-center px-4">
                                <p id="result-title" class="font-bold text-slate-800 text-lg">Inner Join</p>
                                <p id="result-desc" class="text-sm text-slate-600 mt-1">두 테이블 간에 교집합(매칭되는 데이터)만 결과로 추출합니다.</p>
                            </div>
                        </div>

                        <!-- 결과 테이블 -->
                        <div class="bg-blue-50 rounded-lg shadow-inner border border-blue-100 overflow-hidden mt-4">
                            <div class="bg-blue-100 px-4 py-2 text-blue-800 font-bold flex items-center gap-2">
                                <i data-lucide="arrow-right" width="16"></i> <span id="result-count">결과 데이터 (0행)</span>
                            </div>
                            <div class="p-4 overflow-auto max-h-60">
                                <table id="result-table" class="w-full text-sm text-left bg-white rounded-md overflow-hidden shadow-sm">
                                    <thead class="bg-slate-100 text-slate-600">
                                        <tr id="result-table-head">
                                            <!-- JS로 헤더 생성 -->
                                        </tr>
                                    </thead>
                                    <tbody id="result-table-body">
                                        <!-- JS로 바디 생성 -->
                                    </tbody>
                                </table>
                                <div id="no-result-msg" class="hidden text-center text-slate-400 py-4">결과가 없습니다.</div>
                            </div>
                        </div>

                        <!-- SQL Preview -->
                        <div class="mt-6">
                            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 flex justify-between">
                                <span>SQL Query Preview</span>
                                <i data-lucide="copy" width="12" class="cursor-pointer hover:text-blue-600" onclick="copySql()"></i>
                            </div>
                            <div class="bg-slate-800 text-green-400 p-4 rounded-md font-mono text-sm overflow-x-auto shadow-inner relative">
                                <div class="absolute top-2 left-2 flex gap-1.5">
                                    <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                                    <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                                </div>
                                <pre id="sql-preview" class="mt-4 whitespace-pre-wrap leading-relaxed">SELECT ...</pre>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 스크립트 로직 -->
    <script>
        // --- 데이터 정의 ---
        const employees = [
            { id: 1, name: '김철수', deptId: 101 },
            { id: 2, name: '이영희', deptId: 102 },
            { id: 3, name: '박민수', deptId: 999 },
        ];
        const departments = [
            { id: 101, deptName: '인사팀' },
            { id: 102, deptName: '개발팀' },
            { id: 103, deptName: '디자인팀' },
        ];
        const groupA = [
            { id: 1, item: '사과' },
            { id: 2, item: '바나나' },
            { id: 3, item: '포도' },
        ];
        const groupB = [
            { id: 3, item: '포도' }, // 중복
            { id: 4, item: '오렌지' },
            { id: 5, item: '키위' },
        ];

        // --- 상태 관리 ---
        let currentState = {
            mode: 'join',      // 'join' | 'union'
            subOption: 'inner' // 'inner' | 'left' | 'union' | 'unionAll'
        };

        // --- 초기화 및 이벤트 리스너 ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); // 아이콘 초기화
            renderAll();

            // 모드 변경 (Join vs Union)
            document.querySelectorAll('input[name="mainMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentState.mode = e.target.value;
                    currentState.subOption = currentState.mode === 'join' ? 'inner' : 'union';
                    // UI 컨트롤 상태 동기화
                    if (currentState.mode === 'join') {
                        document.getElementById('select-join-sub').value = 'inner';
                    } else {
                        document.querySelector('input[name="unionSub"][value="union"]').checked = true;
                    }
                    renderAll();
                });
            });

            // Join 서브 옵션 변경 (Select)
            document.getElementById('select-join-sub').addEventListener('change', (e) => {
                currentState.subOption = e.target.value;
                renderAll();
            });

            // Union 서브 옵션 변경 (Radio)
            document.querySelectorAll('input[name="unionSub"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentState.subOption = e.target.value;
                    renderAll();
                });
            });

            // 전체화면 버튼
            document.getElementById('btn-fullscreen').addEventListener('click', toggleFullScreen);
        });

        // --- 렌더링 로직 ---
        function renderAll() {
            renderControls();
            renderInputTables();
            renderVisualization();
            renderResult();
            renderSql();
        }

        function renderControls() {
            const joinOpts = document.getElementById('join-options');
            const unionOpts = document.getElementById('union-options');
            const joinDesc = document.getElementById('join-desc');
            const inputHint = document.getElementById('input-hint');

            if (currentState.mode === 'join') {
                joinOpts.classList.remove('hidden');
                unionOpts.classList.add('hidden');
                joinDesc.innerText = currentState.subOption === 'inner' 
                    ? '양쪽 테이블에 공통된 "키(Key)"가 있는 데이터만 남깁니다.' 
                    : '왼쪽 테이블의 모든 데이터를 유지하고, 오른쪽은 매칭되는 것만 가져옵니다.';
                inputHint.innerText = '* 직원의 부서ID와 부서의 ID가 연결 고리(Key)입니다.';
            } else {
                joinOpts.classList.add('hidden');
                unionOpts.classList.remove('hidden');
                inputHint.innerText = '* 두 그룹에 "포도"가 중복되어 있습니다.';
            }
        }

        function createTableHTML(title, columns, data, highlightColor) {
            const headerHtml = columns.map(c => `<th class="pb-1 px-2">${c}</th>`).join('');
            const bodyHtml = data.map(row => {
                const tds = columns.map(col => {
                    let val = '';
                    if (col === 'ID') val = row.id;
                    else if (col === '이름') val = row.name;
                    else if (col === '부서ID') val = row.deptId;
                    else if (col === '부서명') val = row.deptName;
                    else if (col === '아이템') val = row.item;
                    return `<td class="py-2 px-2 text-slate-700">${val}</td>`;
                }).join('');
                return `<tr class="border-b border-slate-50 last:border-0 ${highlightColor}">${tds}</tr>`;
            }).join('');

            return `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                    <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 font-semibold text-slate-700 flex items-center gap-2">
                         <i data-lucide="database" width="16"></i> ${title}
                    </div>
                    <div class="p-2 overflow-auto flex-1">
                        <table class="w-full text-sm text-left">
                            <thead><tr class="border-b border-slate-100 text-slate-500">${headerHtml}</tr></thead>
                            <tbody>${bodyHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderInputTables() {
            const container = document.getElementById('input-tables-container');
            if (currentState.mode === 'join') {
                container.innerHTML = 
                    createTableHTML('A: 직원', ['ID', '이름', '부서ID'], employees, 'bg-blue-50') +
                    createTableHTML('B: 부서', ['ID', '부서명'], departments, 'bg-green-50');
            } else {
                container.innerHTML = 
                    createTableHTML('A: 그룹 1', ['ID', '아이템'], groupA, 'bg-blue-50') +
                    createTableHTML('B: 그룹 2', ['ID', '아이템'], groupB, 'bg-green-50');
            }
            lucide.createIcons(); // 새로 추가된 아이콘 렌더링
        }

        function renderVisualization() {
            const area = document.getElementById('visualization-area');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');

            if (currentState.mode === 'join') {
                // Venn Diagram Logic
                const isLeft = currentState.subOption === 'left';
                const colorLeft = isLeft ? '#60A5FA' : '#E2E8F0';
                const intersectionOpacity = 1; 

                // SVG 생성
                area.innerHTML = `
                <div class="relative w-64 h-40 mx-auto my-4 flex justify-center items-center">
                    <svg viewBox="0 0 200 120" class="w-full h-full drop-shadow-lg">
                        <circle cx="70" cy="60" r="50" fill="${colorLeft}" fill-opacity="0.8" stroke="white" stroke-width="2" />
                        <circle cx="130" cy="60" r="50" fill="#E2E8F0" fill-opacity="0.8" stroke="white" stroke-width="2" />
                        <path d="M 100,20 A 50,50 0 0,1 100,100 A 50,50 0 0,1 100,20 z" fill="#2563EB" opacity="${intersectionOpacity}" />
                        <text x="50" y="65" fill="${isLeft ? 'white' : '#64748B'}" font-size="12" font-weight="bold">A</text>
                        <text x="150" y="65" fill="#64748B" font-size="12" font-weight="bold">B</text>
                    </svg>
                    <div class="absolute -bottom-6 text-xs text-slate-500 font-medium">
                        ${currentState.subOption === 'inner' ? '교집합 (Inner)' : '왼쪽 전체 + 교집합 (Left Outer)'}
                    </div>
                </div>
                `;
                
                title.innerText = currentState.subOption === 'inner' ? 'Inner Join' : 'Left Outer Join';
                desc.innerText = currentState.subOption === 'inner' 
                    ? '두 테이블 간에 교집합(매칭되는 데이터)만 결과로 추출합니다.'
                    : '왼쪽(A) 테이블은 모두 유지하고, 오른쪽(B)에 매칭되는 정보가 없으면 빈칸(Null)으로 둡니다.';

            } else {
                // Union Diagram Logic
                const isUnionAll = currentState.subOption === 'unionAll';
                const resultHeight = isUnionAll ? 'h-32' : 'h-24';
                
                area.innerHTML = `
                <div class="flex flex-col items-center justify-center h-40 gap-2 my-4">
                    <div class="flex gap-4 items-end">
                        <div class="flex flex-col gap-1 items-center">
                            <div class="w-12 h-16 bg-blue-100 border-2 border-blue-400 rounded-md flex items-center justify-center text-xs text-blue-600">A</div>
                        </div>
                        <div class="text-2xl text-slate-400 font-bold">+</div>
                        <div class="flex flex-col gap-1 items-center">
                            <div class="w-12 h-16 bg-green-100 border-2 border-green-400 rounded-md flex items-center justify-center text-xs text-green-600">B</div>
                        </div>
                        <div class="text-2xl text-slate-400 font-bold">=</div>
                        <div class="relative">
                            <div class="w-16 ${resultHeight} bg-indigo-100 border-2 border-indigo-500 rounded-md flex flex-col items-center justify-center text-xs text-indigo-700 transition-all duration-500">
                                <span>결과</span>
                                <span class="text-[10px] opacity-70 mt-1">${isUnionAll ? '전체포함' : '중복제거'}</span>
                            </div>
                            <div class="absolute -right-24 top-1/2 -translate-y-1/2 text-xs px-2 py-1 rounded ${isUnionAll ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-600'}">
                                ${isUnionAll ? '중복 허용' : '중복 1회만'}
                            </div>
                        </div>
                    </div>
                </div>
                `;

                title.innerText = currentState.subOption === 'union' ? 'Union' : 'Union All';
                desc.innerText = currentState.subOption === 'union'
                    ? '두 리스트를 수직으로 합치되, 중복된 데이터("포도")는 한 번만 표시합니다.'
                    : '두 리스트를 무조건 수직으로 합칩니다. 중복된 데이터도 그대로 나옵니다.';
            }
        }

        function renderResult() {
            let data = [];
            let columns = [];

            if (currentState.mode === 'join') {
                columns = ['이름', '부서명'];
                if (currentState.subOption === 'inner') {
                    employees.forEach(emp => {
                        const dept = departments.find(d => d.id === emp.deptId);
                        if (dept) data.push({ name: emp.name, deptName: dept.deptName });
                    });
                } else { // left
                    data = employees.map(emp => {
                        const dept = departments.find(d => d.id === emp.deptId);
                        return { name: emp.name, deptName: dept ? dept.deptName : '(NULL)' };
                    });
                }
            } else {
                columns = ['아이템'];
                if (currentState.subOption === 'union') {
                    const uniqueMap = new Map();
                    [...groupA, ...groupB].forEach(item => uniqueMap.set(item.item, item));
                    data = Array.from(uniqueMap.values());
                } else { // unionAll
                    data = [...groupA, ...groupB];
                }
            }

            // Update DOM
            document.getElementById('result-count').innerText = `결과 데이터 (${data.length}행)`;
            
            const tableHead = document.getElementById('result-table-head');
            const tableBody = document.getElementById('result-table-body');
            const noResult = document.getElementById('no-result-msg');
            const resultTable = document.getElementById('result-table');

            if (data.length === 0) {
                resultTable.classList.add('hidden');
                noResult.classList.remove('hidden');
            } else {
                resultTable.classList.remove('hidden');
                noResult.classList.add('hidden');
                
                tableHead.innerHTML = columns.map(c => `<th class="py-2 px-3">${c}</th>`).join('');
                tableBody.innerHTML = data.map(row => {
                    const cells = columns.map(c => {
                        const val = currentState.mode === 'join' 
                            ? (c === '이름' ? row.name : row.deptName) 
                            : row.item;
                        return `<td class="py-2 px-3 text-slate-800">${val}</td>`;
                    }).join('');
                    return `<tr class="border-b border-slate-100 last:border-0 hover:bg-blue-50 transition-colors">${cells}</tr>`;
                }).join('');
            }
        }

        function renderSql() {
            let sql = '';
            if (currentState.mode === 'join') {
                const joinType = currentState.subOption === 'inner' ? 'INNER JOIN' : 'LEFT OUTER JOIN';
                sql = `SELECT A.name, B.deptName\nFROM Employees A\n${joinType} Departments B\nON A.deptId = B.id;`;
            } else {
                const unionType = currentState.subOption === 'union' ? 'UNION' : 'UNION ALL';
                sql = `SELECT item FROM GroupA\n${unionType}\nSELECT item FROM GroupB;`;
            }
            document.getElementById('sql-preview').innerText = sql;
        }

        function copySql() {
            const sql = document.getElementById('sql-preview').innerText;
            navigator.clipboard.writeText(sql).then(() => {
                alert('SQL이 복사되었습니다!');
            }).catch(err => console.error('복사 실패', err));
        }

        function toggleFullScreen() {
            const elem = document.getElementById('app-container');
            const btnText = document.getElementById('text-fullscreen');
            const btnIcon = document.querySelector('#btn-fullscreen i');

            if (!document.fullscreenElement) {
                elem.requestFullscreen().then(() => {
                    btnText.innerText = '축소';
                    btnIcon.setAttribute('data-lucide', 'minimize');
                    lucide.createIcons();
                }).catch(err => {
                    alert('브라우저 설정으로 인해 전체화면이 차단되었습니다.');
                });
            } else {
                document.exitFullscreen().then(() => {
                    btnText.innerText = '전체화면';
                    btnIcon.setAttribute('data-lucide', 'maximize');
                    lucide.createIcons();
                });
            }
        }
    </script>
</body>
</html>
